<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8">

<title>class Meter - Rails Application Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script src="./js/jquery.js"></script>
<script src="./js/darkfish.js"></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="class">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    <div id="parent-class-section" class="nav-section">
  <h3>Parent</h3>

  
  <p class="link">ActiveRecord::Base
  
</div>

    <div id="includes-section" class="nav-section">
  <h3>Included Modules</h3>

  <ul class="link-list">
  
  
    <li><a class="include" href="Metering.html">Metering</a>
  
  
  </ul>
</div>

    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-c-detailed_predicted_usage_by_meter">::detailed_predicted_usage_by_meter</a>
    
    <li ><a href="#method-c-detailed_predicted_usage_by_time">::detailed_predicted_usage_by_time</a>
    
    <li ><a href="#method-c-detailed_usage_by_meter">::detailed_usage_by_meter</a>
    
    <li ><a href="#method-c-detailed_usage_by_time">::detailed_usage_by_time</a>
    
    <li ><a href="#method-c-get_daily_time_periods">::get_daily_time_periods</a>
    
    <li ><a href="#method-c-import_nem12">::import_nem12</a>
    
    <li ><a href="#method-c-predicted_usage_by_meter">::predicted_usage_by_meter</a>
    
    <li ><a href="#method-c-predicted_usage_by_time">::predicted_usage_by_time</a>
    
    <li ><a href="#method-c-predictor">::predictor</a>
    
    <li ><a href="#method-c-reaggregate">::reaggregate</a>
    
    <li ><a href="#method-c-trim_date_ranges">::trim_date_ranges</a>
    
    <li ><a href="#method-c-usage">::usage</a>
    
    <li ><a href="#method-c-usage_by_meter">::usage_by_meter</a>
    
    <li ><a href="#method-c-usage_by_time">::usage_by_time</a>
    
    <li ><a href="#method-i-detailed_predicted_usage_by_meter">#detailed_predicted_usage_by_meter</a>
    
    <li ><a href="#method-i-detailed_predicted_usage_by_time">#detailed_predicted_usage_by_time</a>
    
    <li ><a href="#method-i-detailed_usage_by_meter">#detailed_usage_by_meter</a>
    
    <li ><a href="#method-i-detailed_usage_by_time">#detailed_usage_by_time</a>
    
    <li ><a href="#method-i-predicted_usage_by_meter">#predicted_usage_by_meter</a>
    
    <li ><a href="#method-i-predicted_usage_by_time">#predicted_usage_by_time</a>
    
    <li ><a href="#method-i-usage">#usage</a>
    
    <li ><a href="#method-i-usage_by_meter">#usage_by_meter</a>
    
    <li ><a href="#method-i-usage_by_time">#usage_by_time</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="class-Meter">
  <h1 id="class-Meter" class="class">
    class Meter
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Class Methods</h3>
       </header>

    
      <div id="method-c-detailed_predicted_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_predicted_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_predicted_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 168</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">detailed_predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
    <span class="ruby-identifier">usages</span> = []
    <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">date_range</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">usages</span> = <span class="ruby-identifier">usages</span> <span class="ruby-operator">+</span> ( <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predictor</span>.<span class="ruby-identifier">detailed_usage_by_meter</span> [<span class="ruby-identifier">date_range</span>], <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span> )
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">usages</span>
<span class="ruby-comment">#    return Meter.predictor.detailed_usage_by_meter date_ranges, daily_time_periods, meters</span>
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-detailed_predicted_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_predicted_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_predicted_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 178</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">detailed_predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
    <span class="ruby-identifier">usages</span> = []
    <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">date_range</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">usages</span> = <span class="ruby-identifier">usages</span> <span class="ruby-operator">+</span> ( <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predictor</span>.<span class="ruby-identifier">detailed_usage_by_time</span> [<span class="ruby-identifier">date_range</span>], <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span> )
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">usages</span>
<span class="ruby-comment">#    return Meter.predictor.detailed_usage_by_time date_ranges, daily_time_periods, meters</span>
  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-detailed_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="detailed_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">detailed_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-value">:meter</span>, <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-detailed_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="detailed_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">detailed_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-value">:time</span>, <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-get_daily_time_periods" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_daily_time_periods</span><span
            class="method-args">(meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Gets the daily time periods for the given Meters</p>
          
          

          
          <div class="method-source-code" id="get_daily_time_periods-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 30</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">get_daily_time_periods</span> <span class="ruby-identifier">meters</span>
  <span class="ruby-comment">#return get_dtps # Used while developing, comment this out when integrating</span>
  <span class="ruby-identifier">daily_time_periods</span> = <span class="ruby-constant">RetailPlan</span>.<span class="ruby-identifier">daily_time_periods</span> <span class="ruby-identifier">meters</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-import_nem12" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">import_nem12</span><span
            class="method-args">(directory, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>STATIC method Read the given directory, import any NEM12 records found,
provided the record is for a <a href="Meter.html">Meter</a> in the received
array of Meters</p>
          
          

          
          <div class="method-source-code" id="import_nem12-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">import_nem12</span> <span class="ruby-identifier">directory</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">MeterRecord</span>.<span class="ruby-identifier">import_nem12</span> <span class="ruby-identifier">directory</span>, <span class="ruby-identifier">meters</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-predicted_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">predicted_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Methods for predicted usage</p>
          
          

          
          <div class="method-source-code" id="predicted_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 151</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-identifier">usages</span> = []
  <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">date_range</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">usages</span> = <span class="ruby-identifier">usages</span> <span class="ruby-operator">+</span> ( <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predictor</span>.<span class="ruby-identifier">usage_by_meter</span> <span class="ruby-identifier">date_range</span>[<span class="ruby-value">:start_date</span>], <span class="ruby-identifier">date_range</span>[<span class="ruby-value">:end_date</span>], <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span> )
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">usages</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-predicted_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">predicted_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="predicted_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 159</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-identifier">usages</span> = []
  <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">date_range</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">usages</span> = <span class="ruby-identifier">usages</span> <span class="ruby-operator">+</span> ( <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predictor</span>.<span class="ruby-identifier">usage_by_time</span> <span class="ruby-identifier">date_range</span>[<span class="ruby-value">:start_date</span>], <span class="ruby-identifier">date_range</span>[<span class="ruby-value">:end_date</span>], <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span> )
  <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">usages</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-predictor" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">predictor</span><span
            class="method-args">()</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Return the class that is being used as a predictor This should probably be
delegated to the <a href="MeterPredictor.html">MeterPredictor</a> class</p>
          
          

          
          <div class="method-source-code" id="predictor-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 20</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">predictor</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">LinearRegressionPredictor</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-reaggregate" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reaggregate</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="reaggregate-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 252</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reaggregate</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>

    <span class="ruby-identifier">meter_ids</span> = <span class="ruby-identifier">meters</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span> }
    <span class="ruby-identifier">dtps_where</span> = <span class="ruby-identifier">daily_time_periods</span>.<span class="ruby-identifier">map</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">dtp</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;          ( start_time = &#39;#{dtp[:start_time]}&#39; AND end_time = &#39;#{dtp[:end_time]}&#39; )\n&quot;</span>}

    <span class="ruby-identifier">t_queries</span> = []
    <span class="ruby-identifier">r_queries</span> = []
    <span class="ruby-identifier">a_queries</span> = []

    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="ruby-comment"># logger.info date_ranges</span>
    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="ruby-comment"># logger.info daily_time_periods</span>
    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="ruby-comment"># logger.info meters</span>
    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="ruby-comment"># logger.info &quot;~~~~~~~~~~~~~~~~~~~~~~~~&quot;</span>




    <span class="ruby-identifier">date_ranges_where</span> = []

    <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">date_range</span><span class="ruby-operator">|</span>

<span class="ruby-comment">#     Used in T, Records R, Aggregations A</span>
      <span class="ruby-identifier">date_range_select_as</span> =            <span class="ruby-node">&quot;        CAST(&#39;#{date_range[:start_date]}&#39; AS date) AS start_date, \n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-node">&quot;        CAST(&#39;#{date_range[:end_date]}&#39; AS date) AS end_date \n&quot;</span>
      <span class="ruby-identifier">date_range_where</span> = <span class="ruby-node">&quot;       ( date &gt;= &#39;#{date_range[:start_date]}&#39; AND date &lt;= &#39;#{date_range[:end_date]}&#39; )\n&quot;</span>
      <span class="ruby-identifier">date_ranges_where</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">date_range_where</span>

      <span class="ruby-identifier">meters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">meter</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">daily_time_periods</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dtp</span><span class="ruby-operator">|</span>

<span class="ruby-comment">#       Write SQL to create a result set, T, containing all the required</span>
<span class="ruby-comment">#       combinations of date range, daily time period / meter</span>
        <span class="ruby-identifier">t_queries</span>.<span class="ruby-identifier">push</span>(
          <span class="ruby-string">&quot;\n    ( \n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    SELECT \n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-node">&quot;        #{meter.id} AS meter_id, \n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-node">&quot;        TO_CHAR(TIMESTAMP &#39;#{dtp[:start_time]}&#39;, &#39;HH24:MI:SS&#39;) AS start_time, \n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-node">&quot;        TO_CHAR(TIMESTAMP &#39;#{dtp[:end_time]}&#39;, &#39;HH24:MI:SS&#39;) AS end_time, \n&quot;</span> <span class="ruby-operator">+</span>                     <span class="ruby-identifier">date_range_select_as</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    ) \n&quot;</span>
        )
        <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">end</span>

<span class="ruby-comment">#     Write SQL queries to count Records</span>
      <span class="ruby-identifier">r_queries</span>.<span class="ruby-identifier">push</span> (
        <span class="ruby-string">&quot;\n    (\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;    SELECT\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_id,\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        COUNT(date) AS records,\n&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">date_range_select_as</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      FROM\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_records\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      WHERE\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_id = ANY(&#39;{&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">meter_ids</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-operator">+</span>                   <span class="ruby-string">&quot;}&#39;::int[])\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      AND\n&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">date_range_where</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      GROUP BY\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_id, start_date, end_date\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;    )\n&quot;</span>
      )

<span class="ruby-comment">#     Write SQL queries to count Aggregations</span>
      <span class="ruby-identifier">a_queries</span>.<span class="ruby-identifier">push</span> (
        <span class="ruby-string">&quot;\n    (\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;    SELECT\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        TO_CHAR(start_time,&#39;HH24:MI:SS&#39;) AS start_time,\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        TO_CHAR(end_time,&#39;HH24:MI:SS&#39;) AS end_time,\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        COUNT(date) AS aggregations,\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_id,\n&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">date_range_select_as</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      FROM\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_aggregations\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      WHERE\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        meter_id = ANY(&#39;{&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">meter_ids</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;,&quot;</span>) <span class="ruby-operator">+</span>                   <span class="ruby-string">&quot;}&#39;::int[])\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      AND\n&quot;</span> <span class="ruby-operator">+</span>                  <span class="ruby-identifier">date_range_where</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      AND\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        (\n&quot;</span> <span class="ruby-operator">+</span>                   <span class="ruby-identifier">dtps_where</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;      OR\n&quot;</span>) <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;        )\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;      GROUP BY meter_id, start_time, end_time\n&quot;</span> <span class="ruby-operator">+</span>          <span class="ruby-string">&quot;    )\n&quot;</span>
      )


    <span class="ruby-keyword">end</span>


<span class="ruby-comment">#   Now construct the structure of the query</span>
<span class="ruby-comment">#   and add our temp table, record and aggregation queries to it</span>
    <span class="ruby-identifier">sql</span> = <span class="ruby-string">&quot;\nSELECT\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.meter_id,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.start_date,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.end_date,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.start_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.end_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.records,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    COALESCE ( A.aggregations, 0 ) AS aggregations\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;\n  FROM\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  (\n&quot;</span> <span class="ruby-operator">+</span>  
<span class="ruby-comment">#   Temp table</span>
    <span class="ruby-string">&quot;SELECT \n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.meter_id, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.start_date, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.end_date, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.start_time, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.end_time, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    COALESCE ( R.records, 0 ) AS records \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;\n  FROM  \n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;-- Create temporary table, T, storing all the required\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;-- combinations of date range, daily time period / meter\n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  (\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-identifier">t_queries</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n    UNION\n&quot;</span>) <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  ORDER BY start_date, end_date, start_time, end_time, meter_id\n&quot;</span> <span class="ruby-operator">+</span>  
    <span class="ruby-string">&quot;\n) T -- all possible combinations of date range, daily time period and meter\n&quot;</span> <span class="ruby-operator">+</span>  

<span class="ruby-comment">#   Add the number of records</span>
    <span class="ruby-string">&quot;\nLEFT JOIN\n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;(\n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;-- Join the number of Records for each combination\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-identifier">r_queries</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n    UNION\n&quot;</span>) <span class="ruby-operator">+</span>  
    <span class="ruby-string">&quot;    ORDER BY\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;      start_date, end_date, meter_id\n&quot;</span> <span class="ruby-operator">+</span>  
    <span class="ruby-string">&quot;) R -- number of records for each combination\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  ON\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.meter_id = R.meter_id\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.start_date = R.start_date\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    T.end_date = R.end_date\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  ORDER BY \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    start_date,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    end_date, \n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    start_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    end_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    meter_id\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;) TR\n\n&quot;</span> <span class="ruby-operator">+</span>  
<span class="ruby-comment">#   Add the number of aggregatons</span>
    <span class="ruby-string">&quot;\nLEFT JOIN\n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;(\n\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;-- Join the number of Aggregations for each combination\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-identifier">a_queries</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n    UNION\n&quot;</span>) <span class="ruby-operator">+</span>  
    <span class="ruby-string">&quot;) A -- number of aggregations for each combination\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  ON\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.meter_id = A.meter_id\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.start_date = A.start_date\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.end_date = A.end_date\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.start_time = A.start_time\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  AND\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    TR.end_time = A.end_time\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;  ORDER BY\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    start_date,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    end_date,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    start_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    end_time,\n&quot;</span> <span class="ruby-operator">+</span>      <span class="ruby-string">&quot;    meter_id\n&quot;</span>

<span class="ruby-comment">#     If left it here, the query will return a table with a row for each combination</span>
<span class="ruby-comment">#   of date range, meter and daily time period, and including the number of</span>
<span class="ruby-comment">#   existing meter records and meter aggregations for each row.</span>
<span class="ruby-comment">#     We can wrap this is another query to compare the difference between</span>
<span class="ruby-comment">#   records and aggregation and only return those rows where there are more</span>
<span class="ruby-comment">#   records than aggregations. These are the time periods, meters and</span>
<span class="ruby-comment">#   date ranges that we need to reaggregate for.</span>

    <span class="ruby-identifier">sql</span> = <span class="ruby-string">&quot;SELECT\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    *\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;  FROM\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    (\n&quot;</span> <span class="ruby-operator">+</span>  
            <span class="ruby-identifier">sql</span> <span class="ruby-operator">+</span>  
          <span class="ruby-string">&quot;    ) C\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    WHERE\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      aggregations &lt; records\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;    ORDER BY\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      start_date,\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      end_date,\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      start_time,\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      end_time,\n&quot;</span> <span class="ruby-operator">+</span>            <span class="ruby-string">&quot;      meter_id\n&quot;</span>

<span class="ruby-comment">#    logger.info sql</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>.<span class="ruby-identifier">connection</span>.<span class="ruby-identifier">raw_connection</span>.<span class="ruby-identifier">exec</span> <span class="ruby-identifier">sql</span>
    <span class="ruby-identifier">date_ranges</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span> []
    <span class="ruby-identifier">dtps</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span> []
    <span class="ruby-identifier">meters</span> = <span class="ruby-constant">Set</span>.<span class="ruby-identifier">new</span> []
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">add</span>( { <span class="ruby-value">:start_date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;start_date&quot;</span>], <span class="ruby-value">:end_date</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;end_date&quot;</span>] } )
      <span class="ruby-identifier">dtps</span>.<span class="ruby-identifier">add</span>( { <span class="ruby-value">:start_time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;start_time&quot;</span>].<span class="ruby-identifier">to_time</span>, <span class="ruby-value">:end_time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;end_time&quot;</span>].<span class="ruby-identifier">to_time</span> } )
      <span class="ruby-identifier">meters</span>.<span class="ruby-identifier">add</span>( <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">find_by_id</span>(<span class="ruby-identifier">r</span>[<span class="ruby-string">&quot;meter_id&quot;</span>]) )
    <span class="ruby-keyword">end</span>


    <span class="ruby-keyword">if</span> <span class="ruby-keyword">not</span> ( <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">daily_time_periods</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">meters</span>.<span class="ruby-identifier">empty?</span> )
      <span class="ruby-constant">MeterAggregation</span>.<span class="ruby-identifier">aggregate_and_store</span> <span class="ruby-identifier">date_ranges</span>.<span class="ruby-identifier">to_a</span>, <span class="ruby-identifier">dtps</span>.<span class="ruby-identifier">to_a</span>, <span class="ruby-identifier">meters</span>.<span class="ruby-identifier">to_a</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-trim_date_ranges" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">trim_date_ranges</span><span
            class="method-args">(date_ranges, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="trim_date_ranges-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 240</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">trim_date_ranges</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-comment"># earliest_date = Date.current unless earliest_date = meters_first_record_date meters</span>
  <span class="ruby-comment"># date_ranges.each do |date_range|</span>
  <span class="ruby-comment">#   if date_range[:start_date] &lt; earliest_date then date_range[:start_date] = earliest_date end</span>
  <span class="ruby-comment"># end</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">date_ranges</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-usage" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage</span><span
            class="method-args">(date_ranges, daily_time_periods, meters, usage_by = :time, detailed = false)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO Move to private</p>
          
          

          
          <div class="method-source-code" id="usage-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 209</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">usage</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-identifier">usage_by</span> = <span class="ruby-value">:time</span>, <span class="ruby-identifier">detailed</span> = <span class="ruby-keyword">false</span>
<span class="ruby-comment">#   Validate the inputs</span>
<span class="ruby-comment">#   Check for valid date ranges</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">bad_date_range_error</span> <span class="ruby-identifier">date_ranges</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_valid_date_ranges</span> <span class="ruby-identifier">date_ranges</span>

    <span class="ruby-identifier">date_ranges</span> = <span class="ruby-identifier">trim_date_ranges</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">meters</span>

<span class="ruby-comment">#   Check for valid daily time periods</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">bad_daily_time_periods_error</span> <span class="ruby-identifier">daily_time_periods</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_valid_daily_time_periods</span> <span class="ruby-identifier">daily_time_periods</span>
<span class="ruby-comment">#   Check that only Meters exist in the meters array</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">badMeterError</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_array_of_meters</span> <span class="ruby-identifier">meters</span>

<span class="ruby-comment">#   Make sure that aggregations exist for all of the daily time periods</span>
<span class="ruby-comment">#   requested in the given date ranges</span>
    <span class="ruby-identifier">reaggregate</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>

<span class="ruby-comment">#   Get the usage</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">usage_by</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:time</span>
        <span class="ruby-identifier">usages</span> = <span class="ruby-constant">MeterAggregation</span>.<span class="ruby-identifier">usage_by_dtp</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-identifier">detailed</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:meter</span>
        <span class="ruby-identifier">usages</span> = <span class="ruby-constant">MeterAggregation</span>.<span class="ruby-identifier">usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-identifier">detailed</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">usages</span> = <span class="ruby-constant">MeterAggregation</span>.<span class="ruby-identifier">usage_by_dtp</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-identifier">detailed</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">usages</span>

  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Methods for actual usage</p>
          
          

          
          <div class="method-source-code" id="usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 130</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-value">:meter</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-c-usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods, meters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 134</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, <span class="ruby-identifier">meters</span>, <span class="ruby-value">:time</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-detailed_predicted_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_predicted_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_predicted_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 108</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">detailed_predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">detailed_predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-detailed_predicted_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_predicted_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_predicted_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 113</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">detailed_predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">detailed_predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-detailed_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 85</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">detailed_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">detailed_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-detailed_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">detailed_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>TODO add this method to SDD</p>
          
          

          
          <div class="method-source-code" id="detailed_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 90</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">detailed_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">detailed_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-predicted_usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">predicted_usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Methods for predicted usage</p>
          
          

          
          <div class="method-source-code" id="predicted_usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 99</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predicted_usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-predicted_usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">predicted_usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="predicted_usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 103</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">predicted_usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-usage" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage</span><span
            class="method-args">(start_date, end_date, start_time, end_time)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Usage for a single given daily time period, given by start_time and
end_time, for this <a href="Meter.html">Meter</a> instance Returns a float</p>
          
          

          
          <div class="method-source-code" id="usage-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 482</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">usage</span>(<span class="ruby-identifier">start_date</span>, <span class="ruby-identifier">end_date</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>)
<span class="ruby-comment">#   Validating the inputs</span>

<span class="ruby-comment">#   Check that the start_date is a date object</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">badDateError</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">is_date</span> <span class="ruby-identifier">start_date</span>
<span class="ruby-comment">#   Check that the start_date is a date object</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">badDateError</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">is_date</span> <span class="ruby-identifier">end_date</span>
<span class="ruby-comment">#   Check that the start_time is a time object</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">badTimeError</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">is_time</span> <span class="ruby-identifier">start_time</span>
<span class="ruby-comment">#   Check that the start_time is a time object</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">badTimeError</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">is_time</span> <span class="ruby-identifier">end_time</span>


<span class="ruby-comment">#   Get the usage from existing daily aggregations</span>
    <span class="ruby-identifier">usage</span> = <span class="ruby-identifier">aggregate_meter_usage</span> <span class="ruby-identifier">start_date</span>, <span class="ruby-identifier">end_date</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>
<span class="ruby-comment">#   IF some usage is found, return it</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">usage</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">usage</span>.<span class="ruby-identifier">nil?</span>


<span class="ruby-comment">#   If no aggregations for this daily time period are found, try creating some</span>
<span class="ruby-comment">#   We&#39;ll want to aggregate the entire date range for this meter</span>
    <span class="ruby-identifier">aggregation_start_date</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">meters_first_record_date</span> [<span class="ruby-keyword">self</span>]

<span class="ruby-comment">#   If there are no meter_records for this Meter, return usage 0</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">0</span> <span class="ruby-keyword">unless</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">is_date</span> <span class="ruby-identifier">aggregation_start_date</span>

<span class="ruby-comment">#   There is at least one meter_record, create some aggregations</span>
    <span class="ruby-identifier">aggregation_end_date</span> = <span class="ruby-constant">Date</span>.<span class="ruby-identifier">today</span>

<span class="ruby-comment">#   Use the daily time period that has been requested</span>
    <span class="ruby-identifier">daily_time_periods</span> = [
      {
        <span class="ruby-value">:start_time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">start_time</span>,
        <span class="ruby-value">:end_time</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">end_time</span>,
      }
    ]

<span class="ruby-comment">#   Try creating the new daily aggregations</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">aggregate_and_store</span> <span class="ruby-identifier">aggregation_start_date</span>, <span class="ruby-identifier">aggregation_end_date</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]

<span class="ruby-comment">#   Try getting the usage again</span>
    <span class="ruby-identifier">usage</span> = <span class="ruby-identifier">aggregate_meter_usage</span> <span class="ruby-identifier">start_date</span>, <span class="ruby-identifier">end_date</span>, <span class="ruby-identifier">start_time</span>, <span class="ruby-identifier">end_time</span>
<span class="ruby-comment">#   Return the usage, or if there isn&#39;t any, return 0</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">usage</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">usage</span> <span class="ruby-operator">:</span> <span class="ruby-value">0</span>


<span class="ruby-comment">#   TODO Iteration 2 -- if there still isn&#39;t any usage, make some up</span>

  <span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-usage_by_meter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage_by_meter</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Methods for actual usage</p>
          
          

          
          <div class="method-source-code" id="usage_by_meter-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 76</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage_by_meter</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-usage_by_time" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">usage_by_time</span><span
            class="method-args">(date_ranges, daily_time_periods)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          
          
          

          
          <div class="method-source-code" id="usage_by_time-source">
            <pre><span class="ruby-comment"># File app/models/meter.rb, line 80</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>
  <span class="ruby-keyword">return</span> <span class="ruby-constant">Meter</span>.<span class="ruby-identifier">usage_by_time</span> <span class="ruby-identifier">date_ranges</span>, <span class="ruby-identifier">daily_time_periods</span>, [<span class="ruby-keyword">self</span>]
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="http://docs.seattlerb.org/rdoc/">RDoc</a> 4.2.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

